#!/usr/bin/env bash
#
#
echo "-----> PORT: $PORT"
export PORT="$PORT"
set -u -e -o pipefail

BUILD_DIR="$1"; shift
mkdir -p "$BUILD_DIR/tmp"

CACHE_DIR="$1"; shift

ENV_DIR="$1"; shift

cd "$CACHE_DIR"

export PATH="$PATH:/sbin"  # === to use ldconfig
export PREFIX="./progs"

CURRENT_VER="$(test -d $PREFIX/nginx && ($PREFIX/nginx/sbin/nginx -v 2>&1 | cut -d'/' -f2) || :)"
LATEST_VER="$((git ls-remote -t https://github.com/openresty/openresty | cut -d'/' -f 3 | sort -r | grep -P '^v[0-9\.]+$' | head -n 1 | cut -d'v' -f2) || :)"

echo "-----> Current OpenResty: $CURRENT_VER"
echo "-----> Latest OpenResty:  $LATEST_VER"

if [[ -z "$LATEST_VER" ]]; then
  echo "-----> !!! Latest version not found." >&2
else
  if [[ "$CURRENT_VER" != "$LATEST_VER" ]]; then
    rm -rf $PREFIX
  fi
fi

echo "-----> PATH:      $PATH"
echo "-----> BUILD_DIR: $BUILD_DIR"
echo "-----> CACHE_DIR: $CACHE_DIR"
echo "-----> ENV_DIR:   $ENV_DIR"
echo "-----> PREFIX:    $PREFIX"

if [[ -e $PREFIX/nginx/sbin/nginx ]] ; then
  echo ""
  echo "-----> Using compiled nginx: $PREFIX"
  echo ""
  echo "-----> Copying:"
  cp -i -r $PREFIX "$BUILD_DIR"/$PREFIX

  echo -n "-----> Copied: "
  $PREFIX/nginx/sbin/nginx -v
  exit 0
fi

mkdir -p $PREFIX
echo "-----> Installing OpenResty:"



# Based on: lua_setup install openresty
#           and on:
#           https://github.com/geoffleyland/heroku-buildpack-openresty/blob/master/bin/compile


cd "$CACHE_DIR"

ARCHIVE="openresty-${LATEST_VER}.tar.gz"
SOURCE_DIR=$(basename "$ARCHIVE" ".tar.gz")
echo "-----> Downloading $ARCHIVE... "
echo "-----> in cache directory: $PWD ["
ls -1
echo "-----> ]"

if [[ ! -d "$SOURCE_DIR" ]]; then
  if [[ ! -s $ARCHIVE ]]; then
    wget --quiet "https://openresty.org/download/${ARCHIVE}"
  fi
  tar -xvf ${ARCHIVE} >/dev/null || { rm $ARCHIVE; rm -rf "$SOURCE_DIR"; exit 1; }
fi

cd $SOURCE_DIR
echo "-----> in openresty source directory: $PWD"

PROCS="$(grep -c '^processor' /proc/cpuinfo)"

# NOTE: /sbin in PATH is needed because OpenResty
# compilation requires ldconfig in PATH.

PATH="$PATH:/sbin" ./configure   \
  --prefix="$PREFIX"             \
  --with-http_iconv_module       \
  --without-http_redis2_module   \
  --with-pcre-jit                \
  --with-luajit                  \
  --with-ipv6                    \
  --with-http_ssl_module         \
  -j$(($PROCS - 1))

  # --error-log-path="$LOG_PREFIX/startup.error.log" \
  # --http-log-path="$LOG_PREFIX/startup.access.log"  \
make
make install


for FILE in "$(echo "$PREFIX"/luajit/lib/libluajit-*.so.2*)" ; do
  ( cd "$(dirname "$FILE")" && ln -s "$(basename "$FILE")" "$(basename "$FILE" .1.0)" )
done

cp -i -r "$PREFIX" "$BUILD_DIR/$PREFIX"
echo -n "-----> Installed in $BUILD_DIR: "
$BUILD_DIR/$PREFIX/nginx/sbin/nginx -v || {
  rm -rf "$PREFIX"
  exit 1;
}


