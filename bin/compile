#!/usr/bin/env bash
#
#
echo "-----> PORT: $PORT"
export PORT="$PORT"
set -u -e -o pipefail

BUILD_DIR="$1"; shift
CACHE_DIR="$1"; shift
ENV_DIR="$1"; shift

export PATH="$PATH:/sbin"  # === to use ldconfig
export PREFIX="$BUILD_DIR/progs"
export COMPILED="$CACHE_DIR/progs"

export LOG_PREFIX="$BUILD_DIR/tmp"
mkdir -p "$LOG_PREFIX"

CURRENT_VER="$(("$COMPILED"/nginx/sbin/nginx -v 2>&1 | cut -d'/' -f2) || :)"
LATEST_VER="$((git ls-remote -t https://github.com/openresty/openresty | cut -d'/' -f 3 | sort -r | grep -P '^v[0-9\.]+$' | head -n 1 | cut -d'v' -f2) || :)"

echo "-----> Current OpenResty: $CURRENT_VER"
echo "-----> Latest OpenResty:  $LATEST_VER"

if [[ -z "$LATEST_VER" ]]; then
  echo "-----> !!! Latest version not found." >&2
else
  if [[ "$CURRENT_VER" != "$LATEST_VER" ]]; then
    rm -rf "$COMPILED"
  fi
fi

echo "-----> PATH:      $PATH"
echo "-----> BUILD_DIR: $BUILD_DIR"
echo "-----> CACHE_DIR: $CACHE_DIR"
echo "-----> ENV_DIR:   $ENV_DIR"
echo "-----> PREFIX:    $PREFIX"
echo "-----> LOG_PREFIX:$LOG_PREFIX"

if [[ ! -z "$("$COMPILED"/nginx/sbin/nginx -v || :)" ]] ; then
  echo ""
  echo "-----> Using compiled nginx: $COMPILED"
  mkdir -p "$BUILD_DIR"
  mkdir -p "$LOG_PREFIX"

  echo ""
  echo "-----> Copying:"
  cp -i -r "$COMPILED" "$PREFIX"

  echo -n "-----> Copied: "
  "$PREFIX"/nginx/sbin/nginx -v
  exit 0
fi

rm -rf "$COMPILED"
mkdir -p "$PREFIX"
echo "-----> Installing OpenResty:"



# Based on: lua_setup install openresty
#           and on:
#           https://github.com/geoffleyland/heroku-buildpack-openresty/blob/master/bin/compile


cd "$CACHE_DIR"

ARCHIVE="openresty-${LATEST_VER}.tar.gz"
SOURCE_DIR=$(basename "$ARCHIVE" ".tar.gz")
echo "-----> Downloading $ARCHIVE... "
echo "-----> in directory: $PWD ["
ls -1
echo "-----> ]"

if [[ ! -d "$SOURCE_DIR" ]]; then
  if [[ ! -s $ARCHIVE ]]; then
    wget --quiet "https://openresty.org/download/${ARCHIVE}"
  fi
  tar -xvf ${ARCHIVE} >/dev/null || { rm $ARCHIVE; rm -rf "$SOURCE_DIR"; exit 1; }
fi

cd $SOURCE_DIR
echo "-----> in openresty source directory: $PWD"

PROCS="$(grep -c '^processor' /proc/cpuinfo)"

# NOTE: /sbin in PATH is needed because OpenResty
# compilation requires ldconfig in PATH.

PATH="$PATH:/sbin" ./configure                      \
  --prefix="$PREFIX"             \
  --with-http_iconv_module       \
  --without-http_redis2_module   \
  --with-pcre-jit                \
  --with-luajit                  \
  --with-ipv6                    \
  --with-http_ssl_module         \
  -j$(($PROCS - 1))

  # --error-log-path="$LOG_PREFIX/startup.error.log" \
  # --http-log-path="$LOG_PREFIX/startup.access.log"  \
make
make install

for FILE in "$(echo "$PREFIX"/luajit/lib/libluajit-*.so.2*)" ; do
  NEW_FILE="$PREFIX"/luajit/lib/"$(basename "$FILE" .1.0)"
  if [[ ! -e "$NEW_FILE" ]]; then
    ln -s "$FILE" "$NEW_FILE"
  fi
done

echo -n "-----> Installed: "
"$PREFIX"/nginx/sbin/nginx -v || {
  rm -rf "$PREFIX"
  exit 1;
}

echo "-----> Copying into cache for next deploy: $COMPILED"
rm -rf "$COMPILED"
cp -i -r "$PREFIX" "$COMPILED"
ls "$COMPILED"
echo "-----------------------------------------|"

echo 1
