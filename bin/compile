#!/usr/bin/env bash
#
#
echo "-----> PORT: $PORT"
export PORT="$PORT"
set -u -e -o pipefail

BUILD_DIR="$1"; shift
CACHE_DIR="$1"; shift
ENV_DIR="$1"; shift

export PATH="$PATH:/sbin"  # === to use ldconfig
export COMPILED_NGINX="$CACHE_DIR/compiled"
export PREFIX="$BUILD_DIR/progs"

export LOG_PREFIX="$BUILD_DIR/tmp"
mkdir -p "$LOG_PREFIX"
touch "$LOG_PREFIX/nginx.pid"

echo "-----> PATH: $PATH"
echo "-----> BUILD_DIR: $BUILD_DIR"
echo "-----> CACHE_DIR: $CACHE_DIR"
echo "-----> ENV_DIR:   $ENV_DIR"
echo "-----> PREFIX:    $PREFIX"
echo "-----> LOG_PREFIX:$LOG_PREFIX"

if [[ -d "$COMPILED_NGINX" ]] ; then
  echo "-----> Using compiled nginx: $COMPILED_NGINX"
  mkdir -p "$BUILD_DIR"
  mkdir -p "$LOG_PREFIX"
  cp -i -r "$COMPILED_NGINX" "$PREFIX"

  echo "-----> ls /tmp"
  ls -al "/tmp"
  echo "-----> ls $PREFIX"
  ls -al "$PREFIX"

  exit 0
else
  mkdir -p "$PREFIX"
fi

echo "-----> Installing OpenResty:"



# Based on: lua_setup install openresty
#           and on:
#           https://github.com/geoffleyland/heroku-buildpack-openresty/blob/master/bin/compile

CURRENT_VER="$(("$PREFIX"/nginx/sbin/nginx -v 2>&1 | cut -d'/' -f2) || :)"
LATEST_VER="$((git ls-remote -t https://github.com/openresty/openresty | cut -d'/' -f 3 | sort -r | grep -P '^v[0-9\.]+$' | head -n 1 | cut -d'v' -f2) || :)"


if [[ -z "$LATEST_VER" ]]; then
  echo "-----> !!! Latest version not found." >&2
  exit 1
fi
if [[ "$CURRENT_VER" == "$LATEST_VER" ]]; then
  echo "-----> Already installed: $CURRENT_VER in $PREFIX" >&2
  exit 0
fi

cd "$PREFIX"

ARCHIVE="openresty-${LATEST_VER}.tar.gz"
SOURCE_DIR=$(basename "$ARCHIVE" ".tar.gz")
echo "-----> Downloading $ARCHIVE... "
echo "-----> in directory: $PWD ["
ls -1
echo "-----> ]"

if [[ ! -d "$SOURCE_DIR" ]]; then
  if [[ ! -s $ARCHIVE ]]; then
    wget --quiet "https://openresty.org/download/${ARCHIVE}"
  fi
  tar -xvf ${ARCHIVE} >/dev/null || { rm $ARCHIVE; rm -rf "$SOURCE_DIR"; exit 1; }
fi

cd $SOURCE_DIR
echo "-----> in openresty source directory: $PWD"

PROCS="$(grep -c '^processor' /proc/cpuinfo)"

# NOTE: /sbin in PATH is needed because OpenResty
# compilation requires ldconfig in PATH.

PATH="$PATH:/sbin" ./configure                      \
  --prefix="$PREFIX"             \
  --with-http_iconv_module       \
  --without-http_redis2_module   \
  --with-pcre-jit                \
  --with-luajit                  \
  --with-ipv6                    \
  --with-http_ssl_module         \
  -j$(($PROCS - 1))

  # --error-log-path="$LOG_PREFIX/startup.error.log" \
  # --http-log-path="$LOG_PREFIX/startup.access.log"  \
make
make install

for FILE in "$(echo "$PREFIX"/luajit/lib/libluajit-*.so.2*)" ; do
  NEW_FILE="$PREFIX"/luajit/lib/"$(basename "$FILE" .1.0)"
  if [[ ! -e "$NEW_FILE" ]]; then
    ln -s "$FILE" "$NEW_FILE"
  fi
done

ls -al "$PREFIX"/luajit/lib/

echo -n "-----> Installed: "
"$PREFIX"/nginx/sbin/nginx -v || {
  rm -rf "$PREFIX"
  exit 1;
}

echo "-----> Copying into cache for next deploy:"
rm -rf "$COMPILED_NGINX"
mkdir -p "$COMPILED_NGINX"
cp -r "$PREFIX" "$COMPILED_NGINX"

